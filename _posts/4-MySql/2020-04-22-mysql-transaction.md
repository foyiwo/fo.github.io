---
layout: post
title: MySQL · InnoDB · 事务原理详解 · 概述
description: ""
modified: 2020-06-27
tags: [高级MySql]

---

### 概述

事务是数据库区别于文件系统的重要特性之一。

数据库中引入事务的主要目的：事务会把数据库从一种一致性状态转换为另一种一致状态。在事务数据库提交工作时，可以确保要么所有修改都保存了，要么所有修改都不保存。

InnoDB存储引擎的事务完全符合事务四个重要的特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability），人们习惯称之为 ACID 特性。下面我逐一对其进行解释：

- **原子性（Atomicity）：**事务开始后所有操作，要么全部做完，要么全部不做，不可能停滞在中间环节。事务执行过程中出错，会回滚到事务开始前的状态，所有的操作就像没有发生一样。例如，如果一个事务需要新增 100 条记录，但是在新增了 10 条记录之后就失败了，那么数据库将回滚对这 10 条新增的记录。也就是说事务是一个不可分割的整体，就像化学中学过的原子，是物质构成的基本单位

- **一致性（Consistency）：**指事务将数据库从一种状态转变为另一种一致的的状态。事务开始前和结束后，数据库的完整性约束没有被破坏。例如工号带有唯一属性，如果经过一个修改工号的事务后，工号变的非唯一了，则表明一致性遭到了破坏。

- **隔离性（Isolation）：**要求每个读写事务的对象对其他事务的操作对象能互相分离，即该事务提交前对其他事务不可见。 也可以理解为多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。这指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。例如一个用户在更新自己的个人信息的同时，是不能看到系统管理员也在更新该用户的个人信息（此时更新事务还未提交）。
注：MySQL 通过锁机制来保证事务的隔离性。

- **持久性（Durability）：**事务一旦提交，则其结果就是永久性的。即使发生宕机的故障，数据库也能将数据恢复，也就是说事务完成后，事务对数据库的所有更新将被保存到数据库，不能回滚。这只是从事务本身的角度来保证，排除 RDBMS（关系型数据库管理系统，例如 Oracle、MySQL 等）本身发生的故障。
注：MySQL 使用 redo log 来保证事务的持久性。

### 事务的分类

从事务理论的角度来说，可以把食物分成以下几种类型：

- 扁平事务（Flat Transactions）
- 带有保存点的扁平事务(Flat Transaction With Savepoints)
- 链事务(Chained Transactions)
- 嵌套事务(Nested Transactions)
- 分布式事务(Distributed Transactions)

##### 1. 扁平事务

扁平事务是事务类型最简单的一种，也是使用最频繁的一种。
其由关键字**BEGIN WORK**开始，由**COMMIT WORK**或**ROLLBACK WORK**结束，其间的操作是原子的，要么都执行，要么都回滚。

##### 2. 带有保存点的扁平事务
详情请另行查询

##### 3. 链事务
详情请另行查询

##### 4. 嵌套事务
详情请另行查询

##### 5. 分布式事务

在一个分布式环境下运行的扁平事务，因此需要根据数据所在位置访问网络中的不同节点。

---

### InnoDB支持

**对于InnoDB存储引擎来说，其支持扁平事务、带有保存点的事务、链事务、分布式事务，对于嵌套事务，其并不原生支持**

---

### 事务控制语句

- BEGIN 或 START TRANSACTION 显式地开启一个事务；
- COMMIT 也可以使用 COMMIT WORK，不过二者是等价的。COMMIT 会提交事务，并使已对数据库进行的所有修改成为永久性的；
- ROLLBACK 也可以使用 ROLLBACK WORK，不过二者是等价的。回滚会结束用户的事务，并撤销正在进行的所有未提交的修改
- SAVEPOINT identifier，SAVEPOINT 允许在事务中创建一个保存点，一个事务中可以有多个 SAVEPOINT；
- RELEASE SAVEPOINT identifier 删除一个事务的保存点，当没有指定的保存点时，执行该语句会抛出一个异常；
- ROLLBACK TO identifier 把事务回滚到标记点；
- SET TRANSACTION 用来设置事务的隔离级别。InnoDB 存储引擎提供事务的隔离级别有READ UNCOMMITTED、READ COMMITTED、REPEATABLE READ 和 SERIALIZABLE。

### MYSQL 事务处理主要有两种方法

1、用 BEGIN, ROLLBACK, COMMIT来实现

- BEGIN 开始一个事务
- ROLLBACK 事务回滚
- COMMIT 事务确认

2、直接用 SET 来改变 MySQL 的自动提交模式:

- SET AUTOCOMMIT=0 禁止自动提交
- SET AUTOCOMMIT=1 开启自动提交

### 事务的实现










